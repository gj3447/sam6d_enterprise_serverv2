version: '3.8'

services:
  pem-server:
    build: .
    container_name: pem-server
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    environment:
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=compute,utility
      - CUDA_VISIBLE_DEVICES=0
      - PEM_MODEL_TYPE=pem
      - PEM_CONFIG_PATH=/workspace/Estimation_Server/SAM-6D/SAM-6D/Pose_Estimation_Model/config/base.yaml
      - PEM_CHECKPOINT_PATH=/workspace/Estimation_Server/SAM-6D/SAM-6D/Pose_Estimation_Model/checkpoints/sam-6d-pem-base.pth
      - PEM_CAD_MODEL_PATH=/workspace/Estimation_Server/SAM-6D/SAM-6D/Data/Example/obj_000005.ply
      - PEM_SERVER_HOST=0.0.0.0
      - PEM_SERVER_PORT=8003
      - PEM_LOG_LEVEL=INFO
      - PEM_PRELOAD_TEMPLATES=true
      - PEM_TEMPLATE_CACHE_MAX=20
      - PEM_CAD_CACHE_MAX=20
      # SAM6D_SAVE_PEM_DETECTIONS
      #   false: detection_pem.json 저장 안 함 (기본)
      #   true : detection_pem.json 저장
      - SAM6D_SAVE_PEM_DETECTIONS=false
      # SAM6D_SAVE_PEM_VISUALIZATION
      #   false: vis_pem.png 저장 안 함
      #   true : 시각화 이미지 저장 (기본)
      - SAM6D_SAVE_PEM_VISUALIZATION=true
    volumes:
      # Estimation_Server 전체 마운트 (상위 디렉토리 전체)
      - ..:/workspace/Estimation_Server
    ports:
      - "8003:8003"
    working_dir: /workspace/Estimation_Server
    # 서버 자동 시작
    command: bash -c "source /opt/conda/bin/activate sam6d && cd /workspace/Estimation_Server/PEM_Server && python main.py"
