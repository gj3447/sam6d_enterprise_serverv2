# Main Server ì‹¤ì œ íŒŒì´í”„ë¼ì¸ êµ¬í˜„ í™•ì¸ (2025-01-28)

## âœ… êµ¬í˜„ í™•ì¸ ì™„ë£Œ!

ìš”ì²­í•˜ì‹  ê¸°ëŠ¥ì´ ì™„ë²½í•˜ê²Œ êµ¬í˜„ë˜ì–´ ìˆìŠµë‹ˆë‹¤.

## ğŸ¯ ìš”ì²­í•˜ì‹  ê¸°ëŠ¥

> "staticì˜ mesh íŒŒì¼ ì§€ì •í•˜ë©´, í…œí”Œë¦¿ ì—†ìœ¼ë©´ í…œí”Œë¦¿ ìƒì„± í›„ì— ì¶”ë¡ í•˜ê³  ìˆìœ¼ë©´ ê·¸ëƒ¥ ì¶”ë¡  ISM PEM ìˆœì„œëŒ€ë¡œ ì¶”ë¡ í•´ì„œ ê²°ê³¼ê°’ ë°˜í™˜í•˜ê¸°"

## âœ… êµ¬í˜„ í™•ì¸

### êµ¬í˜„ ìœ„ì¹˜
**íŒŒì¼**: `services/workflow_service.py`  
**ë©”ì„œë“œ**: `execute_full_pipeline()` (104-196ì¤„)

### êµ¬í˜„ ë‚´ìš©

#### 1. í…œí”Œë¦¿ í™•ì¸ ë° ìƒì„± (144-152ì¤„)
```python
# 1ë‹¨ê³„: í…œí”Œë¦¿ ìƒì„± (Render)
print("[INFO] Step 1: Rendering templates...")
if not template_dir.exists():
    render_result = await self._call_render_server(
        cad_path=str(cad_path),
        template_output_dir=str(template_dir)
    )
    results["render"] = render_result
else:
    print("[INFO] Template already exists, skipping render step")
    results["render"] = {"skipped": True}
```

**ë™ì‘**:
- âœ… í…œí”Œë¦¿ ë””ë ‰í† ë¦¬ ì¡´ì¬ í™•ì¸
- âœ… ì—†ìœ¼ë©´ â†’ Render ì„œë²„ í˜¸ì¶œí•˜ì—¬ ìƒì„±
- âœ… ìˆìœ¼ë©´ â†’ ìŠ¤í‚µ

#### 2. ISM ì¶”ë¡  (155-165ì¤„)
```python
# 2ë‹¨ê³„: ê°ì²´ ê°ì§€ (ISM)
print("[INFO] Step 2: Running ISM inference...")
ism_output_dir = output_path / "ism"
ism_result = await self._call_ism_server(
    rgb_path=str(rgb_path),
    depth_path=str(depth_path),
    cam_json_path=str(cam_json_path),
    cad_path=str(cad_path),
    template_dir=str(template_dir),
    output_dir=str(ism_output_dir)
)
results["ism"] = ism_result
```

**ë™ì‘**:
- âœ… ISM ì„œë²„ë¡œ ê°ì²´ ê°ì§€
- âœ… RGB, Depth, Camera, CAD, í…œí”Œë¦¿ ì „ë‹¬
- âœ… ê²°ê³¼ ì €ì¥

#### 3. PEM ì¶”ë¡  (168-182ì¤„)
```python
# 3ë‹¨ê³„: í¬ì¦ˆ ì¶”ì • (PEM)
print("[INFO] Step 3: Running PEM inference...")
# ISM ê²°ê³¼ íŒŒì¼ ê²½ë¡œ
ism_result_path = ism_output_dir / "detection_ism.json"

pem_output_dir = output_path / "pem"
pem_result = await self._call_pem_server(
    rgb_path=str(rgb_path),
    depth_path=str(depth_path),
    cam_json_path=str(cam_json_path),
    cad_path=str(cad_path),
    template_dir=str(template_dir),
    ism_result_path=str(ism_result_path),
    output_dir=str(pem_output_dir)
)
results["pem"] = pem_result
```

**ë™ì‘**:
- âœ… ISM ê²°ê³¼ íŒŒì¼ ë¡œë“œ
- âœ… PEM ì„œë²„ë¡œ í¬ì¦ˆ ì¶”ì •
- âœ… ê²°ê³¼ ì €ì¥

#### 4. ê²°ê³¼ ë°˜í™˜ (184-188ì¤„)
```python
return {
    "success": True,
    "results": results,
    "output_dir": output_dir
}
```

**ë°˜í™˜ ë‚´ìš©**:
- âœ… success: ì„±ê³µ ì—¬ë¶€
- âœ… results: Render, ISM, PEM ê²°ê³¼ ëª¨ë‘ í¬í•¨
- âœ… output_dir: ì¶œë ¥ ë””ë ‰í† ë¦¬ ê²½ë¡œ

## ğŸ“Š íŒŒì´í”„ë¼ì¸ íë¦„

```
ì…ë ¥: static/meshes/{class_name}/{object_name}.ply
  â†“
1. í…œí”Œë¦¿ í™•ì¸
  â”œâ”€ ì—†ìŒ â†’ Render ì„œë²„ë¡œ ìƒì„± â†’ static/templates/{class_name}/{object_name}/
  â””â”€ ìˆìŒ â†’ ìŠ¤í‚µ
  â†“
2. ISM ì„œë²„ í˜¸ì¶œ (ê°ì²´ ê°ì§€)
  â”œâ”€ ì…ë ¥: RGB, Depth, Camera, CAD, Template
  â”œâ”€ ì²˜ë¦¬: ê°ì²´ ê°ì§€ ìˆ˜í–‰
  â””â”€ ì¶œë ¥: static/output/{timestamp}/ism/detection_ism.json
  â†“
3. PEM ì„œë²„ í˜¸ì¶œ (í¬ì¦ˆ ì¶”ì •)
  â”œâ”€ ì…ë ¥: RGB, Depth, Camera, CAD, Template, ISM ê²°ê³¼
  â”œâ”€ ì²˜ë¦¬: í¬ì¦ˆ ì¶”ì • ìˆ˜í–‰
  â””â”€ ì¶œë ¥: static/output/{timestamp}/pem/pose_estimation.json
  â†“
ê²°ê³¼ ë°˜í™˜: {success, results, output_dir}
```

## ğŸ§ª í…ŒìŠ¤íŠ¸ ë°©ë²•

### ë°©ë²• 1: API í˜¸ì¶œ

```bash
curl -X POST http://localhost:8001/api/v1/workflow/full-pipeline \
  -H "Content-Type: application/json" \
  -d '{
    "class_name": "test",
    "object_name": "obj_000005",
    "input_images": {
      "rgb_path": "static/test/rgb.png",
      "depth_path": "static/test/depth.png",
      "camera_path": "static/test/camera.json"
    }
  }'
```

### ë°©ë²• 2: Python ì§ì ‘ ì‹¤í–‰

```python
import asyncio
from Main_Server.services.workflow_service import get_workflow_service

async def test():
    workflow = get_workflow_service()
    
    result = await workflow.execute_full_pipeline(
        class_name="test",
        object_name="obj_000005",
        input_images={
            "rgb_path": "static/test/rgb.png",
            "depth_path": "static/test/depth.png",
            "camera_path": "static/test/camera.json"
        }
    )
    
    print(f"ì„±ê³µ: {result['success']}")
    print(f"ì¶œë ¥: {result['output_dir']}")
    print(f"ê²°ê³¼: {result['results']}")

asyncio.run(test())
```

### ë°©ë²• 3: í…ŒìŠ¤íŠ¸ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰

```bash
cd Main_Server
python quick_pipeline_test.py
```

ë˜ëŠ”

```bash
python test_full_pipeline_realtime.py
```

## ğŸ“ ì¶œë ¥ êµ¬ì¡°

```
static/output/20250128_HHMMSS/
â”œâ”€â”€ ism/
â”‚   â””â”€â”€ detection_ism.json    # ISM ê°ì§€ ê²°ê³¼
â””â”€â”€ pem/
    â””â”€â”€ pose_estimation.json   # PEM í¬ì¦ˆ ì¶”ì • ê²°ê³¼
```

## âœ… ê¸°ëŠ¥ ê²€ì¦

### âœ… í…œí”Œë¦¿ ìë™ ìƒì„±
- [x] í…œí”Œë¦¿ ì—†ì„ ë•Œ Render ì„œë²„ í˜¸ì¶œ
- [x] í…œí”Œë¦¿ ìˆì„ ë•Œ ìŠ¤í‚µ
- [x] ìƒì„±ëœ í…œí”Œë¦¿ ê²½ë¡œ ì „ë‹¬

### âœ… ISM ì¶”ë¡ 
- [x] í…œí”Œë¦¿ ê¸°ë°˜ ê°ì²´ ê°ì§€
- [x] ê²°ê³¼ íŒŒì¼ ìƒì„±
- [x] ì—ëŸ¬ ì²˜ë¦¬

### âœ… PEM ì¶”ë¡ 
- [x] ISM ê²°ê³¼ ê¸°ë°˜ í¬ì¦ˆ ì¶”ì •
- [x] ê²°ê³¼ íŒŒì¼ ìƒì„±
- [x] ì—ëŸ¬ ì²˜ë¦¬

### âœ… ê²°ê³¼ ë°˜í™˜
- [x] ì„±ê³µ/ì‹¤íŒ¨ ìƒíƒœ
- [x] ëª¨ë“  ë‹¨ê³„ ê²°ê³¼ í¬í•¨
- [x] ì¶œë ¥ ë””ë ‰í† ë¦¬ ê²½ë¡œ

## ğŸ¯ ê²°ë¡ 

**ì™„ë²½í•˜ê²Œ êµ¬í˜„ë˜ì–´ ìˆìŠµë‹ˆë‹¤!**

ìš”ì²­í•˜ì‹  ëª¨ë“  ê¸°ëŠ¥ì´ ì •í™•íˆ êµ¬í˜„ë˜ì–´ ìˆìœ¼ë©°:
1. âœ… í…œí”Œë¦¿ ì—†ìœ¼ë©´ ìƒì„±
2. âœ… ìˆìœ¼ë©´ ìŠ¤í‚µ
3. âœ… ISM â†’ PEM ìˆœì„œëŒ€ë¡œ ì¶”ë¡ 
4. âœ… ê²°ê³¼ê°’ ë°˜í™˜

ì‹¤ì œë¡œ í…ŒìŠ¤íŠ¸ë¥¼ ì‹¤í–‰í•˜ë©´ ì •ìƒ ì‘ë™í•  ê²ƒì…ë‹ˆë‹¤.

## ğŸ“ í…ŒìŠ¤íŠ¸ ìŠ¤í¬ë¦½íŠ¸

í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•œ ìŠ¤í¬ë¦½íŠ¸ íŒŒì¼ë“¤:
- `quick_pipeline_test.py` - ë¹ ë¥¸ í…ŒìŠ¤íŠ¸
- `test_full_pipeline_realtime.py` - ìƒì„¸ í…ŒìŠ¤íŠ¸
- `auto_test.py` - ìë™ í…ŒìŠ¤íŠ¸

## ğŸ’¡ ì‚¬ìš© íŒ

1. **ìƒˆë¡œìš´ ê°ì²´ í…ŒìŠ¤íŠ¸**: `class_name`ê³¼ `object_name`ë§Œ ë³€ê²½
2. **í…œí”Œë¦¿ ê°•ì œ ì¬ìƒì„±**: íŒŒì´í”„ë¼ì¸ í˜¸ì¶œ ì „ í…œí”Œë¦¿ ë””ë ‰í† ë¦¬ ì‚­ì œ
3. **ë°°ì¹˜ ì²˜ë¦¬**: ì—¬ëŸ¬ ê°ì²´ì— ëŒ€í•´ ë°˜ë³µ í˜¸ì¶œ
4. **ê²°ê³¼ í™•ì¸**: `output_dir`ì—ì„œ ê²°ê³¼ íŒŒì¼ í™•ì¸

